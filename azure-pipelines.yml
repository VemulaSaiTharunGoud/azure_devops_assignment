trigger:
  - main

pool:
  name: 'self-hosted'
  demands:
    - agent.os -equals Linux

variables:
  TARGET_USER: 'devops'
  TARGET_HOST: '192.168.1.10'     # <-- CHANGE to your deployment VM IP
  TARGET_APP_DIR: '/var/www/app'
  BACKUP_DIR: '/var/www/artifacts/last'
  ZIP_NAME: 'app_$(Build.BuildId).zip'

steps:
# Deploy: copy artifact, backup current app, extract, install and restart
- script: |
    echo "==> Deploying to ${TARGET_USER}@${TARGET_HOST}"
    scp -o StrictHostKeyChecking=no $(Build.ArtifactStagingDirectory)/$(ZIP_NAME) ${TARGET_USER}@${TARGET_HOST}:/tmp/$(ZIP_NAME)

    ssh -o StrictHostKeyChecking=no ${TARGET_USER}@${TARGET_HOST} /bin/bash << 'EOF'
    set -e

    sudo mkdir -p ${BACKUP_DIR}
    if [ -d "${TARGET_APP_DIR}" ] && [ "$(ls -A ${TARGET_APP_DIR} 2>/dev/null)" ]; then
      sudo rm -rf ${BACKUP_DIR}/*
      sudo cp -r ${TARGET_APP_DIR}/* ${BACKUP_DIR}/ || true
      echo "Previous version backed up to ${BACKUP_DIR}"
    else
      sudo mkdir -p ${TARGET_APP_DIR}
    fi

    sudo unzip -o /tmp/$(ZIP_NAME) -d ${TARGET_APP_DIR}
    sudo chown -R ${TARGET_USER}:${TARGET_USER} ${TARGET_APP_DIR}

    cd ${TARGET_APP_DIR} || exit 1
    sudo -u ${TARGET_USER} npm install --no-optional

    if command -v pm2 >/dev/null 2>&1; then
      pm2 stop app || true
      pm2 start index.js --name app || pm2 restart app
      pm2 save || true
    else
      pkill -f "node .*index.js" || true
      nohup sudo -u ${TARGET_USER} node index.js > /var/log/app.out 2>&1 &
    fi

    echo "Deployment steps complete"
EOF
  displayName: 'Deploy to target via SSH'

# Rollback step: runs only if previous job failed
- script: |
    echo "==> Rollback triggered: restoring last backup"
    ssh -o StrictHostKeyChecking=no ${TARGET_USER}@${TARGET_HOST} /bin/bash << 'EOF'
    set -e
    if [ -d "${BACKUP_DIR}" ] && [ "$(ls -A ${BACKUP_DIR} 2>/dev/null)" ]; then
      sudo rm -rf ${TARGET_APP_DIR}/*
      sudo cp -r ${BACKUP_DIR}/* ${TARGET_APP_DIR}/
      sudo chown -R ${TARGET_USER}:${TARGET_USER} ${TARGET_APP_DIR}
      if command -v pm2 >/dev/null 2>&1; then
        pm2 stop app || true
        pm2 start index.js --name app || pm2 restart app
      else
        pkill -f "node .*index.js" || true
        nohup sudo -u ${TARGET_USER} node index.js > /var/log/app.out 2>&1 &
      fi
      echo "Rollback completed: previous version restored"
    else
      echo "No backup found. Cannot rollback."
    fi
EOF
  displayName: 'Rollback (restore previous version)'
  condition: failed()
